variables:
  # For package builds
  PHOSH_DOCKER_IMAGE: debian:trixie
  PHOSH_PKG_GIT_SUBMODULE_UPDATE: 'true'
  PHOSH_PKG_OUTPUT_DIR: debian/output/

.phosh-prepare-apt: |
   echo "man-db man-db/auto-update boolean false" | debconf-set-selections
   export DEBIAN_FRONTEND=noninteractive
   apt-get -y update
   apt-get -y install eatmydata ${PHOSH_ADDITIONAL_PKGS}

.phosh-build-debian-package:
  image: ${PHOSH_DOCKER_IMAGE}
  needs: []
  script:
    # setup
    - !reference [.phosh-prepare-apt]
    - eatmydata apt-get -y --no-install-recommends install build-essential git devscripts
    - eatmydata apt-get -y --no-install-recommends build-dep .
    - rm -f ../* || true
    # run
    - '[ "$PHOSH_PKG_GIT_SUBMODULE_UPDATE" != "true" ] || git submodule update --recursive'
    - REV=$(git log -1 --format=%h)
    - VER=$(dpkg-parsechangelog -SVersion)
    - '[ -n "$CI_MERGE_REQUEST_TITLE" ] && MSG="Build of \"$CI_MERGE_REQUEST_TITLE\" at $REV" || MSG="Build of $REV"'
    - 'DEBFULLNAME="CI build" EMAIL="ci-builds@phosh.mobi" dch -v"$VER+librem5ci$CI_PIPELINE_ID.$REV" "$MSG"'
    - dpkg-buildpackage -b -uc -us
    - rm -rf "${PHOSH_PKG_OUTPUT_DIR}"; mkdir -p "${PHOSH_PKG_OUTPUT_DIR}"
    - cp -l ../*.changes ../*.buildinfo "${PHOSH_PKG_OUTPUT_DIR}/"
    - cp -l ../*.deb  "${PHOSH_PKG_OUTPUT_DIR}/" || true
    - cp -l ../*.udeb "${PHOSH_PKG_OUTPUT_DIR}/" || true
    - ls "${PHOSH_PKG_OUTPUT_DIR}/"/*.*deb
  artifacts:
    expose_as: 'Debian packages'
    paths:
      - debian/output/

.phosh-check-po:
  image: ${PHOSH_DOCKER_IMAGE}
  variables:
    PHOSH_ADDITIONAL_PKGS: intltool gettext
  needs: []
  script:
    - !reference [.phosh-prepare-apt]
    - .gitlab-ci/check-po
